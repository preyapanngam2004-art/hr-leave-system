<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>หน้าอนุมัติ - ระบบลางานออนไลน์</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="navbar">
        <div class="logo">ระบบลางาน (หัวหน้า)</div>
        <nav>
            <a href="manager.html">รายการอนุมัติ</a>
            <a href="report.html">ดูรายงานทีม</a>
            <a href="#" id="navUsername">(กำลังโหลด...)</a>
            <a href="login.html" onclick="localStorage.clear()">ออกจากระบบ</a>
        </nav>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>รายการรออนุมัติ</h2>
                <a href="#" class="btn-primary" id="openLeaveModalBtn">ยื่นใบลา (ของฉัน)</a>
            </div>
            
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>พนักงาน</th>
                            <th>ประเภทการลา</th>
                            <th>วันที่ลา</th>
                            <th>เหตุผล</th>
                            <th>ไฟล์แนบ</th>
                            <th>ดำเนินการ</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTableBody">
                        <tr><td colspan="6" style="text-align: center;">กำลังโหลดรายการ...</td></tr>
                    </tbody>
                </table>
            </div>
            </div>
    </div>

    <div class="modal-overlay" id="leaveModal">
        <div class="modal-content">
            <h2>ยื่นใบลา (สำหรับหัวหน้า)</h2>
            <form id="leaveForm">
                <div class="form-group">
                    <label for="leaveType">ประเภทการลา</label>
                    <select id="leaveType" name="leaveType" required>
                        <option value="">-- กรุณาเลือก --</option>
                        <option value="1">ลาป่วย</option>
                        <option value="2">ลากิจ</option>
                        <option value="3">ลาพักร้อน</option>
                        <option value="4" id="maternityLeaveOption" style="display:none;">ลาคลอด</option>
                        <option value="5" id="ordinationLeaveOption" style="display:none;">ลาบวช</option>
                        <option value="6" id="militaryLeaveOption" style="display:none;">ลาเกณฑ์ทหาร</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="startDate">วันที่เริ่มลา</label>
                    <input type="date" id="startDate" name="startDate" required>
                </div>
                <div class="form-group">
                    <label for="endDate">วันที่สิ้นสุด</label>
                    <input type="date" id="endDate" name="endDate" required>
                </div>
                <div class="form-group">
                    <label for="reason">เหตุผลการลา</label>
                    <textarea id="reason" name="reason" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="attachmentFile">แนบไฟล์ (ถ้ามี)</label>
                    <input type="file" id="attachmentFile" name="attachmentFile">
                </div>

                <div class="form-group">
                    <label for="approverId">ส่งให้ใครอนุมัติ (ผู้บริหาร)</label>
                    <select id="approverId" name="managerId" required>
                        <option value="">-- เลือกผู้อนุมัติ --</option>
                        <option value="1">ปรียา ปั้นงาม (ผู้บริหาร)</option> 
                    </select>
                </div>

                <button type="submit" class="btn" id="submitLeaveBtn">ส่งใบลา</button>
                <button type="button" class="btn" id="closeLeaveModalBtn" style="background-color: #6c757d; margin-top: 10px;">ยกเลิก</button>
            </form>
        </div>
    </div>


<script>
    // [!! แก้ไขแล้ว: กำหนด Base URL เป็น IP จริงเพื่อแก้ปัญหาการเชื่อมต่อจากโทรศัพท์ !!]
    // [!! แทนที่ด้วย URL สาธารณะจาก ngrok ของคุณที่ได้มา !!]
    const API_BASE_URL = '';
    const manager = JSON.parse(localStorage.getItem('user'));

    document.addEventListener('DOMContentLoaded', () => {
        if (!manager || manager.Manager_ID !== null) { 
            alert('กรุณาเข้าสู่ระบบด้วยบัญชีหัวหน้า');
            window.location.href = './login.html'; 
            return;
        }
        document.getElementById('navUsername').textContent = `(หัวหน้า) ${manager.FirstName}`;
        loadPendingRequests(manager.Emp_ID);

        // (ซ่อนปุ่ม "ยื่นใบลา" ถ้าเป็น ID 1 (ปรียา))
        if (manager.Emp_ID === 1) { 
            document.getElementById('openLeaveModalBtn').style.display = 'none';
        }
    });

    async function loadPendingRequests(managerId) {
        const tableBody = document.getElementById('pendingTableBody'); 
        try {
            // [แก้ไขแล้ว]: เปลี่ยน localhost เป็น API_BASE_URL
            const response = await fetch(`${API_BASE_URL}/api/pending-requests/${managerId}`);
            if (!response.ok) throw new Error('Failed to fetch');
            const requests = await response.json();
            tableBody.innerHTML = ''; 
            if (requests.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ไม่พบรายการรออนุมัติ</td></tr>';
                 return;
            }
            requests.forEach(r => {
                let fileLink = '-';
                if (r.AttachmentFile) {
                    // [แก้ไขแล้ว]: เปลี่ยน localhost ในลิงก์ไฟล์แนบ
                    fileLink = `<a href="${API_BASE_URL}/uploads/${r.AttachmentFile}" target="_blank">ดูไฟล์</a>`;
                }

                tableBody.innerHTML += `
                    <tr>
                        <td>${r.FirstName} ${r.LastName}</td>
                        <td>${r.TypeName}</td>
                        <td>${new Date(r.StartDate).toLocaleDateString('th-TH')}</td>
                        <td>${r.Reason || '-'}</td>
                        <td>${fileLink}</td>
                        <td>
                            <a href="#" class="btn-approve" onclick="processRequest(${r.Request_ID}, 'Approved')">อนุมัติ</a>
                            <a href="#" class="btn-reject" onclick="processRequest(${r.Request_ID}, 'Rejected')">ปฏิเสธ</a>
                        </td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error('Fetch Pending Requests Error:', error); 
            // ข้อความผิดพลาดที่เห็นในหน้าจอล่าสุด
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ไม่สามารถโหลดข้อมูลได้</td></tr>';
        }
    }

    async function processRequest(requestId, newStatus) {
        const statusInThai = newStatus === 'Approved' ? 'อนุมัติ' : 'ปฏิเสธ'; 
        if (!confirm(`คุณแน่ใจหรือไม่ที่จะ "${statusInThai}" รายการนี้?`)) { 
            return; 
        }
        try {
            // [แก้ไขแล้ว]: เปลี่ยน localhost เป็น API_BASE_URL
            const response = await fetch(`${API_BASE_URL}/api/process-request`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ requestId, newStatus })
            });
            const result = await response.json();
            if (response.ok) {
                alert(result.message); 
                loadPendingRequests(manager.Emp_ID); 
            } else {
                alert('เกิดข้อผิดพลาด: ' + result.message);
            }
        } catch (error) {
            console.error('Process Request Error:', error);
            alert('ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้');
        }
    }

    const modal = document.getElementById('leaveModal');
    const openBtn = document.getElementById('openLeaveModalBtn');
    const closeBtn = document.getElementById('closeLeaveModalBtn');
    
    openBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const currentUser = JSON.parse(localStorage.getItem('user'));
        
        const maternityOption = document.getElementById('maternityLeaveOption');
        const ordinationOption = document.getElementById('ordinationLeaveOption');
        const militaryOption = document.getElementById('militaryLeaveOption');

        maternityOption.style.display = 'none';
        ordinationOption.style.display = 'none';
        militaryOption.style.display = 'none';

        if (currentUser && currentUser.Gender === 'หญิง') {
            maternityOption.style.display = 'block';
        } else if (currentUser && currentUser.Gender === 'ชาย') {
            ordinationOption.style.display = 'block';
            militaryOption.style.display = 'block';
        }
        
        const approverDropdown = document.getElementById('approverId');
        Array.from(approverDropdown.options).forEach(option => {
            if (option.value == currentUser.Emp_ID) {
                option.style.display = 'none';
            } else {
                option.style.display = 'block';
            }
        });
        approverDropdown.value = ""; 

        modal.style.display = 'block';
    });
    
    closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
        leaveForm.reset(); 
    });
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
            leaveForm.reset();
        }
    });

    const leaveForm = document.getElementById('leaveForm');
    const submitBtn = document.getElementById('submitLeaveBtn');

    leaveForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const selectedApproverId = document.getElementById('approverId').value;
        if (!selectedApproverId) {
            alert('กรุณาเลือกผู้บริหารที่จะส่งใบลาไปให้');
            return;
        }
        
        submitBtn.disabled = true; 
        submitBtn.textContent = 'กำลังส่ง...';
        
        const formData = new FormData(leaveForm);
        formData.append('empId', manager.Emp_ID);

        try {
            // [แก้ไขแล้ว]: เปลี่ยน localhost เป็น API_BASE_URL
            const response = await fetch(`${API_BASE_URL}/api/submit-leave`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            if (response.ok) {
                alert('ส่งใบลา (ของหัวหน้า) สำเร็จ!');
                modal.style.display = 'none';
                leaveForm.reset();
            } else {
                alert('เกิดข้อผิดพลาด: ' + result.message);
            }
        } catch (error) {
            console.error('Submit Error:', error);
            alert('ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้');
        } finally {
            submitBtn.disabled = false; 
            submitBtn.textContent = 'ส่งใบลา';
        }
    });

</script>
